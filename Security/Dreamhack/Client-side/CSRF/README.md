# CSRF ( Cross Site Request Forgery)

## 목차
1. [개요](#개요)
2. [사용이유](#사용이유)
3. [조건](#조건)
4. [예시](#예시)
5. [해결방안](#해결방안)

## 개요 

웹 브라우저는 통상적으로
`Same-Origin-Policy`에 위반되지 않은
모든 요청에 쿠키를 함께 전송한다.

비 정상적으로 **사용자의 의도와 무관하게**
다른 사이트에 HTTP요청을 보내는 것을
**CSRF** 공격이라 한다.

## 사용 이유

이를 통해 얻을 수 있는 이득은
해당 세션 쿠키를 가진 사람만
사용 할 수 있는 기능을 사용 가능하다는 것이다.

기존 권한을 갖고 있는 사용자가 사용 가능한 정상적 기능을
공격자가 사용자의 의도와 무관하게
요청을 보내 원하는 이득을 얻을 수 있다.

예를 들어, 공격자에게 임의 금액을 송금하게
만들어 금전적 이득을 얻거나,
사용자의 패스워드를 공격자가 임의로 설정한
값으로 변경해 계정을 탈취하거나,
관리자 권한을 가진 유저를 공격해
공지사항을 작성, 혼란을 야기시킬 수 있다.

## 조건
CSRF 공격을 성공적으로 수행하기 위해서는
아래의 2가지 조건이 요구된다.

1. **해당 웹 사이트가 쿠키를 이용한 인증 방식을 사용해야 한다.**
    ```txt
    모든 HTTP전송엔 쿠키가 함께 전송되기에
    쿠키에 저장된 세션 아이디도 전송된다.
    ```

2. **공격자가 사전에 알 수 없는 파라미터가 존재해서는 안된다.**

    ```txt
    1. 자동입력 방지 문자를 넣어야 하는
       요청은 공격자가 알 수 없다.

    2. 패스워드 변경 기능에서 기존 패스워드를
       입력 받는 다면 이 또한 공격자가 미리 알 수 없다.
    ```

## 예시
```html
<img src="/sendmoney?to=dreamhack&amount=1337">

<img src=1 onerror="fetch('/sendmoney?to=dreamhack&amount=1337');">

<link rel="stylesheet" href="/sendmoney?to=dreamhack&amount=1337">
```

## 해결방안
이를 막기 위해서는 통상적으로
두가지의 방법이 있습니다.

1. 세션 쿠키 대신 커스텀 헤더를
사용하여 사용자 인증
    - 사용자 인증만을 위한 헤더 추가
        EX : Authorization

2. 공격자가 예측할 수 없는
파라미터 추가 및 검증
    - Same Origin에서만
    접근 가능한 데이터를 삽입
        - CSRF Token
    - CAPTCHA
    - 정상적인 사용자만 아는 기존의 값을 검증
        EX : 현재 비밀번호

-----
위의 두 방법은 서버측에서 추가적인 검증을 통해
CSRF를 방어하는 방법입니다.

서버코드에 검증 로직이 추가되는 방식이라 어쩔 수 없는 오버헤드가 발생하게 된다.

CSRF 공격이 가능한 이유를 다시 한번 생각해보면
웹 브라우저가 크로스 사이트
즉 다른 사이트로부터 시작된 요청에 쿠키를 함께 요청하기 때문이다.

웹 브라우저가 쿠키를 다른 사이트로부터 시작된 요청에 삽입할지를
SameSite 쿠키 설정을 보고 결정하게 된다.

쿠키에는 `key=value`를 포함해 추가적인 설정 값도
함께 저장합니다.
기존 **Domain**, **Expires**, **Path**만 있었지만
새롭게 SameSite옵션도 추가되었다.

크로스 사이트에서 출발한 요청에
제한적으로 쿠키를 포함시키게 하는 옵션이다.
총 3가지(`Strict`, `Lax`, `Normal`) 값을 설정 할 수 있다.
아무것도 설정하지 않을시 `Normal`과 동일한 권한을 가집니다.

기본적으로 Strict은 모든 크로스 사이트에서
출발한 요청에 해당 쿠키를 삽입하지 않는다.

Lax는 Link, Prerender, Form GET를 제외한
요청에는 삽입하지 않고 Normal은 기존과 같이 모든 요청에 삽입합니다.

Normal 옵션은 기존과 동일하게 모든 요청에
쿠키를 삽입합니다.

> 크롬 브라우저는 2020년부터 개발자가 강제로
> SameSite=None; Secure;를
> 넣지 않는 이상 웹 브라우저는 모든 쿠키에
> SameSite=Lax를 강제한다.

|Lax|\<a>|\<link>|\<form method="GET">|||
|------|---|---|-----|------|-------|
|Normal|\<a>|/<link>|\<form method="GET">|\<form method>|ajax, iag...|


**[Home](https://github.com/sunrabbit123/Learn_Web_Security)**
